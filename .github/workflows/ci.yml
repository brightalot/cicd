name: ğŸ”¨ CI Pipeline

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‘ì—…
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” ì½”ë“œ ë¦°íŒ… (flake8)
      run: |
        flake8 app.py test_app.py --max-line-length=100 --statistics
    
    - name: ğŸ¨ ì½”ë“œ í¬ë§¤íŒ… í™•ì¸ (black)
      run: |
        black --check app.py test_app.py --line-length=100
    
    - name: ğŸ”¢ Import ì •ë ¬ í™•ì¸ (isort)
      run: |
        isort --check-only app.py test_app.py --profile black --line-length=100
    
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python -c "from app import add, multiply, get_app_info; print('âœ… ê¸°ë³¸ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ í†µê³¼')"
    
    # ğŸ³ Docker ë¹Œë“œ ì‘ì—…
  docker-build:
    name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: cicd-practice-app:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ§ª Docker ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸
      run: |
        # ì´ë¯¸ì§€ ë¹Œë“œ
        docker build -t cicd-practice-app:test .
        
        # ì»¨í…Œì´ë„ˆ ì‹œì‘
        docker run -d -p 8000:8000 --name test-app cicd-practice-app:test
        
        # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        sleep 10
        
        # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
        curl -f http://localhost:8000/health || exit 1
        
        # ìƒíƒœ API í…ŒìŠ¤íŠ¸  
        curl -f http://localhost:8000/api/status || exit 1
        
        # ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker stop test-app
        docker rm test-app
    
  # ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ì‘ì—…
  security-scan:
    name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
    
    - name: ğŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ (safety)
      run: |
        safety check --json || true  # ê²½ê³ ë§Œ í‘œì‹œ, ì‹¤íŒ¨ì‹œì—ë„ ê³„ì† ì§„í–‰
    
    - name: ğŸ•µï¸ ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº” (bandit)
      run: |
        bandit -r . -f json -o bandit-report.json || true
        if [ -f bandit-report.json ]; then
          echo "ğŸ” ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼:"
          cat bandit-report.json | python -m json.tool
        fi

  # ğŸ“ˆ ê²°ê³¼ ìš”ì•½
  ci-success:
    name: âœ… CI ì„±ê³µ
    runs-on: ubuntu-latest
    needs: [test, docker-build, security-scan]
    if: success()
    
    steps:
    - name: ğŸ‰ CI íŒŒì´í”„ë¼ì¸ ì„±ê³µ
      run: |
        echo "ğŸ‰ ëª¨ë“  CI ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "âœ… í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… Docker ë¹Œë“œ ì„±ê³µ" 
        echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
        echo "ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!"
